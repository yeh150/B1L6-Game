<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>B1L6 You Can Do It! - å¤¢æƒ³åäººå ‚</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* æ¦®è€€è—é‡‘ä¸»é¡Œï¼šè±¡å¾µæˆåŠŸèˆ‡å¤¢æƒ³ */
        body { font-family: 'Noto Sans TC', 'Nunito', sans-serif; touch-action: manipulation; background-color: #f0fdfa; }
        
        .theme-bg { background-color: #4f46e5; } /* Indigo-600 */
        .theme-text { color: #4338ca; } /* Indigo-700 */
        .theme-accent { color: #fbbf24; } /* Amber-400 (Gold) */
        
        .pulse-ring { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .card-selected { 
            border-color: #4f46e5 !important; 
            background-color: #e0e7ff !important; 
            border-width: 3px !important;
            transform: scale(0.98);
        }
        .shake { animation: shake 0.5s; }
        @keyframes shake {
            0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); }
        }
        .progress-bar { transition: width 1s linear; }
    </style>
</head>
<body class="h-screen flex flex-col items-center overflow-hidden bg-gradient-to-br from-indigo-50 to-blue-100">

    <!-- APP CONTAINER -->
    <div id="app" class="w-full max-w-md h-full bg-white shadow-2xl relative overflow-hidden sm:rounded-xl sm:h-[95vh] sm:my-4 sm:border-4 sm:border-indigo-200 flex flex-col">
        
        <!-- HEADER -->
        <div class="theme-bg text-white p-4 z-20 shadow-md flex justify-between items-center shrink-0">
            <h1 class="font-bold text-lg"><i class="fas fa-trophy mr-2 text-yellow-300"></i>Dream Hall of Fame</h1>
            <div class="flex items-center space-x-2">
                <span id="level-badge" class="text-xs bg-indigo-800 px-2 py-1 rounded-full hidden border border-indigo-400">Level 1</span>
                <span id="score-display" class="font-mono font-bold hidden text-yellow-300">0%</span>
            </div>
        </div>

        <!-- CONTENT AREA (Scrollable) -->
        <div id="main-content" class="flex-1 relative overflow-y-auto overflow-x-hidden">
            
            <!-- VIEW: START -->
            <div id="view-start" class="h-full flex flex-col justify-center items-center p-8 space-y-6">
                <div class="text-center space-y-2">
                    <div class="w-24 h-24 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4 text-5xl shadow-md border-4 border-white relative">
                        ğŸŒŸ
                        <div class="absolute -bottom-2 -right-2 bg-yellow-400 w-8 h-8 rounded-full flex items-center justify-center text-xs border-2 border-white">1st</div>
                    </div>
                    <h2 class="text-3xl font-black text-gray-800 tracking-wider">å¤¢æƒ³åäººå ‚<br><span class="text-indigo-600">å–®å­—æŒ‘æˆ°è³½</span></h2>
                    <p class="text-gray-500 font-bold">B1L6: You Can Do It!</p>
                </div>
                
                <div class="bg-indigo-50 p-5 rounded-xl w-full text-sm space-y-3 border border-indigo-100 shadow-sm">
                    <h3 class="font-bold theme-text mb-2 text-base"><i class="fas fa-flag-checkered mr-2"></i>å† è»ä¹‹è·¯ï¼š</h3>
                    <p class="flex items-center"><span class="w-6 h-6 rounded-full bg-indigo-200 text-indigo-700 flex items-center justify-center text-xs font-bold mr-2">1</span> <span class="font-bold">è½éŸ³è¾¨ç¾©</span>ï¼šè½åŠ›ç‰¹è¨“</p>
                    <p class="flex items-center"><span class="w-6 h-6 rounded-full bg-indigo-200 text-indigo-700 flex items-center justify-center text-xs font-bold mr-2">2</span> <span class="font-bold">æ¥µé€Ÿé…å°</span>ï¼šåæ‡‰åŠ›æ¸¬è©¦ (90s)</p>
                    <p class="flex items-center"><span class="w-6 h-6 rounded-full bg-indigo-200 text-indigo-700 flex items-center justify-center text-xs font-bold mr-2">3</span> <span class="font-bold">å£èªªç™¼è¡¨</span>ï¼šå¤§è²èªªå‡ºè‡ªä¿¡</p>
                    <div class="mt-2 pt-2 border-t border-indigo-200">
                        <p class="text-red-500 text-xs font-bold text-center"><i class="fas fa-exclamation-triangle mr-1"></i> æ­£ç¢ºç‡ 80% æ‰èƒ½æ™‰ç´šæ±ºè³½ï¼</p>
                    </div>
                </div>

                <div class="w-full space-y-3">
                    <input type="text" id="username-input" placeholder="è«‹è¼¸å…¥é¸æ‰‹å§“å" class="w-full p-3 border-2 border-indigo-200 rounded-xl text-center focus:outline-none focus:border-indigo-500 bg-white text-lg font-bold text-indigo-900 placeholder-indigo-300">
                    <button onclick="startGame()" class="w-full theme-bg hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition flex items-center justify-center text-lg">
                        <i class="fas fa-rocket mr-2"></i> æŒ‘æˆ°é–‹å§‹
                    </button>
                </div>
            </div>

            <!-- VIEW: LEVEL INTRO (Transition) -->
            <div id="view-intro" class="h-full flex flex-col justify-center items-center p-8 hidden bg-indigo-600 text-white z-30 absolute top-0 left-0 w-full">
                <div class="text-center animate-bounce">
                    <i id="intro-icon" class="fas fa-headphones-alt text-7xl mb-6 text-yellow-300 drop-shadow-md"></i>
                    <h2 id="intro-title" class="text-4xl font-bold mb-2 tracking-wide">Level 1</h2>
                    <p id="intro-desc" class="text-indigo-100 text-xl font-bold">è½éŸ³è¾¨ç¾©</p>
                </div>
                <button onclick="startLevelActual()" class="mt-12 bg-yellow-400 text-indigo-900 font-bold py-3 px-10 rounded-full shadow-xl hover:bg-yellow-300 active:scale-95 transition transform hover:-translate-y-1">
                    Ready? GO!
                </button>
            </div>

            <!-- VIEW: LEVEL 1 (Listening) -->
            <div id="view-level1" class="h-full flex flex-col p-6 hidden">
                <div class="flex-1 flex flex-col justify-center items-center space-y-8">
                    <!-- Progress -->
                    <div class="w-full h-3 bg-gray-200 rounded-full mb-4">
                        <div id="l1-progress" class="h-full theme-bg rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>

                    <!-- Audio Button -->
                    <button onclick="playL1Audio()" class="w-36 h-36 rounded-full bg-white text-indigo-600 shadow-xl flex items-center justify-center active:scale-95 transition hover:bg-indigo-50 border-4 border-indigo-100 group">
                        <i class="fas fa-volume-up text-6xl group-hover:scale-110 transition-transform"></i>
                    </button>
                    <p class="text-indigo-400 text-sm font-bold">é»æ“Šè†è½é¡Œç›®</p>

                    <!-- Options -->
                    <div id="l1-options" class="w-full grid grid-cols-1 gap-3">
                        <!-- Options injected by JS -->
                    </div>
                </div>
            </div>

            <!-- VIEW: LEVEL 2 (Matching) -->
            <div id="view-level2" class="h-full flex flex-col hidden relative">
                <!-- Timer Bar -->
                <div class="w-full h-3 bg-gray-200">
                    <div id="l2-timer-bar" class="h-full bg-green-500 progress-bar" style="width: 100%"></div>
                </div>
                <div class="text-center py-2 bg-indigo-50 border-b border-indigo-100 flex justify-between px-4 shadow-sm z-10">
                    <span class="text-sm text-gray-600 font-bold">å‰©é¤˜: <span id="l2-remaining" class="font-bold theme-text text-lg">10</span> çµ„</span>
                    <span class="text-sm text-gray-600 font-bold">æ™‚é–“: <span id="l2-time-text" class="font-bold text-red-500 text-lg">90</span>s</span>
                </div>

                <!-- Grid Container (Scrollable) -->
                <div id="l2-grid" class="flex-1 grid grid-cols-2 gap-3 p-4 content-start overflow-y-auto pb-20 bg-indigo-50/30">
                    <!-- Cards injected by JS -->
                </div>
            </div>

            <!-- VIEW: LEVEL 3 (Speaking) -->
            <div id="view-level3" class="h-full flex flex-col p-6 hidden">
                <div class="text-center mb-6">
                     <div class="w-full h-3 bg-gray-200 rounded-full mb-2">
                        <div id="l3-progress" class="h-full bg-purple-500 rounded-full" style="width: 0%"></div>
                    </div>
                    <p class="text-xs text-gray-400 font-bold">Question <span id="l3-q-num">1</span> / 10</p>
                </div>

                <div class="flex-1 flex flex-col items-center justify-center space-y-6">
                    <!-- Word Card -->
                    <div class="w-full bg-white border-2 border-indigo-100 rounded-2xl shadow-xl p-8 text-center relative">
                        <div class="absolute -top-4 left-1/2 transform -translate-x-1/2 bg-purple-600 text-white px-4 py-1 rounded-full text-xs font-bold shadow-md">
                            SPEAK UP
                        </div>
                        <h2 id="l3-word" class="text-4xl font-black text-gray-800 mb-2 mt-4">Example</h2>
                        <h3 id="l3-meaning" class="text-xl text-indigo-500 font-bold">ç¯„ä¾‹</h3>
                        
                        <!-- Play Audio Button -->
                        <button onclick="playL3Hint()" class="mt-6 bg-indigo-50 text-indigo-600 px-5 py-2 rounded-full text-sm font-bold flex items-center justify-center mx-auto hover:bg-indigo-100 transition border border-indigo-100">
                            <i class="fas fa-volume-up mr-2"></i> è½ç¤ºç¯„ç™¼éŸ³
                        </button>
                    </div>

                    <!-- Feedback -->
                    <div id="l3-feedback" class="h-12 flex items-center justify-center text-center">
                        <p class="text-gray-400 text-sm font-bold animate-bounce">ğŸ‘‡ é»æ“Šéº¥å…‹é¢¨é–‹å§‹éŒ„éŸ³</p>
                    </div>
                </div>

                <!-- Controls -->
                <div class="mt-auto pb-8 w-full flex items-center justify-center relative px-6">
                    
                    <!-- Mic Button (Center) -->
                    <button id="l3-mic-btn" onclick="toggleL3Mic()" class="w-20 h-20 rounded-full bg-red-500 text-white shadow-xl flex items-center justify-center active:scale-95 transition text-3xl z-10 border-4 border-red-100 ring-4 ring-red-50">
                        <i id="l3-mic-icon" class="fas fa-microphone"></i>
                    </button>

                    <!-- Skip Button (Right) -->
                    <button onclick="skipL3Question()" class="absolute right-4 flex flex-col items-center justify-center text-gray-400 hover:text-indigo-500 transition group p-2">
                        <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center mb-1 group-hover:bg-indigo-50 shadow-sm border border-gray-100">
                            <i class="fas fa-forward text-base"></i>
                        </div>
                        <span class="text-xs font-bold">ç•¥é</span>
                    </button>

                </div>
            </div>

            <!-- VIEW: RESULT / FAIL -->
            <div id="view-result" class="h-full flex flex-col justify-center items-center p-6 hidden bg-white">
                <div id="result-card" class="w-full max-w-sm bg-white rounded-3xl shadow-2xl border-4 border-yellow-300 p-6 text-center relative overflow-hidden">
                    <!-- Decorative background shapes -->
                    <div class="absolute -top-10 -right-10 w-32 h-32 bg-yellow-100 rounded-full opacity-50"></div>
                    <div class="absolute -bottom-10 -left-10 w-32 h-32 bg-indigo-100 rounded-full opacity-50"></div>

                    <div id="result-header" class="mb-4 relative z-10">
                        <div class="w-20 h-20 bg-gradient-to-br from-yellow-300 to-yellow-500 rounded-full flex items-center justify-center mx-auto mb-2 text-4xl text-white shadow-lg border-4 border-white">ğŸ†</div>
                        <h2 class="text-2xl font-black text-gray-800">æˆç¸¾å–®</h2>
                        <p id="result-user" class="theme-text font-bold text-lg mt-1">Player 1</p>
                    </div>

                    <!-- Scores Table -->
                    <div class="space-y-3 mb-6 relative z-10">
                        <div class="flex justify-between items-center p-3 bg-indigo-50 rounded-xl border border-indigo-100">
                            <span class="text-sm font-bold text-gray-600">L1 è½åŠ›</span>
                            <span id="score-l1" class="font-mono font-black text-lg text-indigo-700">--%</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-indigo-50 rounded-xl border border-indigo-100">
                            <span class="text-sm font-bold text-gray-600">L2 é…å°</span>
                            <span id="score-l2" class="font-mono font-black text-lg text-indigo-700">--%</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-indigo-50 rounded-xl border border-indigo-100">
                            <span class="text-sm font-bold text-gray-600">L3 å£èªª</span>
                            <span id="score-l3" class="font-mono font-black text-lg text-indigo-700">--%</span>
                        </div>
                    </div>

                    <div id="result-message-box" class="bg-yellow-50 p-4 rounded-xl mb-4 border border-yellow-200 relative z-10">
                        <p id="result-comment" class="text-yellow-800 font-bold text-sm">è©•èªè¼‰å…¥ä¸­...</p>
                    </div>

                    <!-- Action Buttons -->
                    <div id="action-buttons" class="relative z-10">
                        <!-- Injected by JS -->
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Data & Logic -->
    <script>
        // --- 1. DATA (B1L6 You Can Do It! - Updated) ---
        // Context: Success, Famous people, Salesperson, Trust, Laughter, Missed bus, Wallet on stairs, Excitement
        const vocabDB = [
            { id: 1, en: "salesperson", ch: "éŠ·å”®å“¡/æ¥­å‹™å“¡" },
            { id: 2, en: "service", ch: "æœå‹™" },
            { id: 3, en: "trust", ch: "ä¿¡ä»»/ä¿¡è³´" },
            { id: 4, en: "customer", ch: "é¡§å®¢" },
            { id: 5, en: "laughter", ch: "ç¬‘è²" },
            { id: 6, en: "miss", ch: "éŒ¯é/æƒ³å¿µ" },
            { id: 7, en: "wallet", ch: "çš®å¤¾" },
            { id: 8, en: "stairs", ch: "æ¨“æ¢¯" },
            { id: 9, en: "excitement", ch: "èˆˆå¥®" },
            { id: 10, en: "successful", ch: "æˆåŠŸçš„" },
            { id: 11, en: "experience", ch: "ç¶“é©—/é«”é©—" },
            { id: 12, en: "encourage", ch: "é¼“å‹µ" },
            { id: 13, en: "offer", ch: "æä¾›" },
            { id: 14, en: "give up", ch: "æ”¾æ£„" },
            { id: 15, en: "fill with", ch: "å……æ»¿" },
            { id: 16, en: "turn out", ch: "çµæœæ˜¯/åŸä¾†æ˜¯" },
            { id: 17, en: "solve", ch: "è§£æ±º" }
        ];

        // --- 2. STATE ---
        let gameState = {
            user: "",
            currentLevel: 1, // 1, 2, 3
            scores: { l1: 0, l2: 0, l3: 0 },
            l1Data: [],
            l1Index: 0,
            l1CorrectCount: 0,
            l2Data: [],
            l2PairsLeft: 0,
            l2TimeLeft: 0,
            l2Timer: null,
            l2Selected: null,
            l2Lock: false,
            l3Data: [],
            l3Index: 0,
            l3CorrectCount: 0,
            l3MistakeMade: false
        };

        let recognition;
        let isListening = false;

        // --- 3. CORE FUNCTIONS ---

        function startGame() {
            const name = document.getElementById('username-input').value.trim();
            if(!name) return alert("è«‹è¼¸å…¥é¸æ‰‹å§“åï¼");
            gameState.user = name;
            gameState.currentLevel = 1;
            
            initSpeech();
            startLevel(1);
        }

        function startLevel(level) {
            gameState.currentLevel = level;
            
            const views = ['view-start', 'view-intro', 'view-level1', 'view-level2', 'view-level3', 'view-result'];
            views.forEach(v => document.getElementById(v).classList.add('hidden'));
            
            const intro = document.getElementById('view-intro');
            intro.classList.remove('hidden');
            
            const titles = ["è½éŸ³è¾¨ç¾©", "æ¥µé€Ÿé…å°", "å£èªªç‰¹è¨“"];
            const icons = ["fa-headphones-alt", "fa-bolt", "fa-microphone-alt"];
            const descs = ["è½ç™¼éŸ³ï¼Œé¸å‡ºæ­£ç¢ºçš„ä¸­æ–‡æ„æ€", "90ç§’å…§å®Œæˆå–®å­—é…å° (éš¨æ©Ÿ10é¡Œ)", "å¤§è²å”¸å‡ºå–®å­—ï¼Œå±•ç¾è‡ªä¿¡ (éš¨æ©Ÿ10é¡Œ)"];
            
            document.getElementById('intro-title').innerText = `Level ${level}: ${titles[level-1]}`;
            // Correct icon class string
            document.getElementById('intro-icon').className = `fas ${icons[level-1]} text-7xl mb-6 text-yellow-300 drop-shadow-md`;
            document.getElementById('intro-desc').innerText = descs[level-1];
            
            document.getElementById('level-badge').innerText = `Level ${level}`;
            document.getElementById('level-badge').classList.remove('hidden');
        }

        function startLevelActual() {
            document.getElementById('view-intro').classList.add('hidden');
            const level = gameState.currentLevel;

            if (level === 1) initLevel1();
            else if (level === 2) initLevel2();
            else if (level === 3) initLevel3();
        }

        // --- LEVEL 1: LISTENING ---
        function initLevel1() {
            document.getElementById('view-level1').classList.remove('hidden');
            gameState.l1Data = shuffle([...vocabDB]);
            gameState.l1Index = 0;
            gameState.l1CorrectCount = 0;
            renderLevel1Question();
        }

        function renderLevel1Question() {
            if (gameState.l1Index >= gameState.l1Data.length) {
                endLevel1();
                return;
            }

            const current = gameState.l1Data[gameState.l1Index];
            const pct = (gameState.l1Index / gameState.l1Data.length) * 100;
            document.getElementById('l1-progress').style.width = `${pct}%`;

            setTimeout(() => speak(current.en), 500);

            const others = vocabDB.filter(w => w.id !== current.id);
            const wrongOptions = shuffle(others).slice(0, 3);
            const options = shuffle([current, ...wrongOptions]);

            const container = document.getElementById('l1-options');
            container.innerHTML = "";
            
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "w-full bg-white border-2 border-indigo-100 p-4 rounded-xl text-gray-700 font-bold shadow-sm hover:bg-indigo-50 active:bg-indigo-100 transition text-lg";
                btn.innerText = opt.ch;
                btn.onclick = () => checkLevel1Answer(opt.id, current.id, btn);
                container.appendChild(btn);
            });
        }

        function playL1Audio() {
            const current = gameState.l1Data[gameState.l1Index];
            speak(current.en);
        }

        function checkLevel1Answer(selectedId, correctId, btn) {
            const btns = document.getElementById('l1-options').children;
            for(let b of btns) b.disabled = true;

            if (selectedId === correctId) {
                btn.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
                gameState.l1CorrectCount++;
                setTimeout(() => {
                    gameState.l1Index++;
                    renderLevel1Question();
                }, 800);
            } else {
                btn.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
                for(let b of btns) {
                    if (b.innerText === gameState.l1Data[gameState.l1Index].ch) {
                        b.classList.add('bg-green-100', 'border-green-500');
                    }
                }
                setTimeout(() => {
                    gameState.l1Index++;
                    renderLevel1Question();
                }, 1500);
            }
        }

        function endLevel1() {
            const accuracy = Math.round((gameState.l1CorrectCount / gameState.l1Data.length) * 100);
            gameState.scores.l1 = accuracy;
            
            if (accuracy >= 80) {
                showResultScreen(true, "Level 1 é€šé—œï¼æ™‰ç´šä¸‹ä¸€è¼ª", () => startLevel(2));
            } else {
                showResultScreen(false, "ç‰¹è¨“å¤±æ•—ï¼è«‹é‡æ–°æŒ‘æˆ° Level 1", () => startLevel(1));
            }
        }

        // --- LEVEL 2: MATCHING ---
        function initLevel2() {
            document.getElementById('view-level2').classList.remove('hidden');
            const selection = shuffle([...vocabDB]).slice(0, 10);
            gameState.l2Data = selection;
            gameState.l2PairsLeft = 10;
            gameState.l2TimeLeft = 90;
            gameState.l2Selected = null;
            gameState.l2Lock = false;

            let cards = [];
            selection.forEach(item => {
                cards.push({ id: item.id, type: 'en', text: item.en });
                cards.push({ id: item.id, type: 'ch', text: item.ch });
            });
            cards = shuffle(cards);

            const grid = document.getElementById('l2-grid');
            grid.innerHTML = "";
            cards.forEach(card => {
                const el = document.createElement('div');
                el.className = "bg-white p-2 rounded-xl shadow-sm border-2 border-indigo-100 flex items-center justify-center text-center cursor-pointer h-24 font-bold text-sm select-none active:scale-95 transition hover:border-indigo-300";
                el.innerText = card.text;
                el.dataset.id = card.id;
                el.dataset.type = card.type;
                el.onclick = () => handleCardClick(el);
                grid.appendChild(el);
            });

            document.getElementById('l2-remaining').innerText = 10;
            document.getElementById('l2-time-text').innerText = 90;
            document.getElementById('l2-timer-bar').style.width = '100%';

            if (gameState.l2Timer) clearInterval(gameState.l2Timer);
            gameState.l2Timer = setInterval(() => {
                gameState.l2TimeLeft--;
                document.getElementById('l2-time-text').innerText = gameState.l2TimeLeft;
                const pct = (gameState.l2TimeLeft / 90) * 100;
                document.getElementById('l2-timer-bar').style.width = `${pct}%`;

                if (gameState.l2TimeLeft <= 0) {
                    clearInterval(gameState.l2Timer);
                    endLevel2(false);
                }
            }, 1000);
        }

        function handleCardClick(el) {
            if (gameState.l2Lock || el.style.display === 'none' || el.classList.contains('card-selected')) return;

            el.classList.add('card-selected');

            if (!gameState.l2Selected) {
                gameState.l2Selected = el;
            } else {
                const first = gameState.l2Selected;
                gameState.l2Lock = true;

                if (first.dataset.id === el.dataset.id && first.dataset.type !== el.dataset.type) {
                    setTimeout(() => {
                        first.style.display = 'none';
                        el.style.display = 'none';
                        first.classList.remove('card-selected');
                        el.classList.remove('card-selected');
                        
                        gameState.l2PairsLeft--;
                        document.getElementById('l2-remaining').innerText = gameState.l2PairsLeft;
                        gameState.l2Selected = null;
                        gameState.l2Lock = false;

                        if (gameState.l2PairsLeft === 0) {
                            clearInterval(gameState.l2Timer);
                            endLevel2(true);
                        }
                    }, 300);
                } else {
                    setTimeout(() => {
                        first.classList.add('shake', 'border-red-400', 'bg-red-50');
                        el.classList.add('shake', 'border-red-400', 'bg-red-50');
                        first.classList.remove('card-selected');
                        el.classList.remove('card-selected');
                    }, 100);

                    setTimeout(() => {
                        first.classList.remove('shake', 'border-red-400', 'bg-red-50');
                        el.classList.remove('shake', 'border-red-400', 'bg-red-50');
                        gameState.l2Selected = null;
                        gameState.l2Lock = false;
                    }, 800);
                }
            }
        }

        function endLevel2(finished) {
            const pairsFound = 10 - gameState.l2PairsLeft;
            const score = Math.round((pairsFound / 10) * 100);
            gameState.scores.l2 = score;

            if (score >= 80) {
                showResultScreen(true, "Level 2 é€šé—œï¼å‰å¾€æœ€çµ‚æ±ºè³½", () => startLevel(3));
            } else {
                showResultScreen(false, "æ™‚é–“åˆ°ï¼å®Œæˆåº¦ä¸è¶³ï¼Œè«‹å†è©¦ä¸€æ¬¡", () => startLevel(2));
            }
        }

        // --- LEVEL 3: SPEAKING ---
        function initLevel3() {
            document.getElementById('view-level3').classList.remove('hidden');
            gameState.l3Data = shuffle([...vocabDB]).slice(0, 10);
            gameState.l3Index = 0;
            gameState.l3CorrectCount = 0;
            renderLevel3Question();
        }

        function renderLevel3Question() {
            if (gameState.l3Index >= gameState.l3Data.length) {
                endLevel3();
                return;
            }

            const current = gameState.l3Data[gameState.l3Index];
            gameState.l3MistakeMade = false;

            document.getElementById('l3-progress').style.width = `${(gameState.l3Index / 10) * 100}%`;
            document.getElementById('l3-q-num').innerText = gameState.l3Index + 1;

            document.getElementById('l3-word').innerText = capitalize(current.en);
            document.getElementById('l3-meaning').innerText = current.ch;

            document.getElementById('l3-feedback').innerHTML = '<p class="text-gray-400 text-sm font-bold animate-bounce">ğŸ‘‡ é»æ“Šéº¥å…‹é¢¨é–‹å§‹éŒ„éŸ³</p>';
            resetMicUI();
        }

        function toggleL3Mic() {
            if (!recognition) { alert("ç€è¦½å™¨ä¸æ”¯æ´"); return; }
            if (isListening) {
                recognition.stop();
                isListening = false;
                resetMicUI();
            } else {
                try { recognition.start(); } 
                catch(e) { recognition.stop(); isListening = false; resetMicUI(); }
            }
        }

        function resetMicUI() {
            const micBtn = document.getElementById('l3-mic-btn');
            micBtn.disabled = false;
            micBtn.classList.remove('bg-gray-400', 'bg-red-600', 'pulse-ring');
            micBtn.classList.add('bg-red-500');
            document.getElementById('l3-mic-icon').className = "fas fa-microphone";
        }

        function skipL3Question() {
            if (recognition) recognition.abort();
            isListening = false;
            gameState.l3Index++;
            renderLevel3Question();
        }

        function playL3Hint() {
            const word = gameState.l3Data[gameState.l3Index].en;
            speak(word, 0.75);
        }

        function initSpeech() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onstart = () => {
                    isListening = true;
                    const btn = document.getElementById('l3-mic-btn');
                    btn.classList.add('pulse-ring', 'bg-red-600');
                    btn.classList.remove('bg-red-500');
                    document.getElementById('l3-mic-icon').className = "fas fa-stop";
                    document.getElementById('l3-feedback').innerHTML = '<p class="text-red-500 animate-pulse font-bold">è†è½ä¸­...è«‹èªªè‹±æ–‡</p>';
                };

                recognition.onend = () => { isListening = false; resetMicUI(); };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript.toLowerCase();
                    checkSpeaking(transcript);
                };

                recognition.onerror = (event) => {
                    if (event.error === 'no-speech') {
                         document.getElementById('l3-feedback').innerHTML = '<p class="text-yellow-600 font-bold">æ²’è½åˆ°è²éŸ³ï¼Œè«‹å†è©¦ä¸€æ¬¡</p>';
                    } else {
                        document.getElementById('l3-feedback').innerHTML = '<p class="text-gray-400 font-bold">æ”¶éŸ³ä¸­æ–·ï¼Œè«‹é‡æŒ‰éº¥å…‹é¢¨</p>';
                    }
                    isListening = false;
                    resetMicUI();
                };
            }
        }

        function checkSpeaking(transcript) {
            const target = gameState.l3Data[gameState.l3Index].en.toLowerCase();
            let isCorrect = false;

            if (transcript.includes(target) || target === transcript) isCorrect = true;
            // Fuzzy match logic
            if (target.length > 4 && Math.abs(transcript.length - target.length) < 3 && transcript.startsWith(target[0])) isCorrect = true;

            if (isCorrect) {
                document.getElementById('l3-feedback').innerHTML = `<p class="text-green-600 font-bold"><i class="fas fa-check"></i> Nice! (${transcript})</p>`;
                if(!gameState.l3MistakeMade) gameState.l3CorrectCount++;
                setTimeout(() => {
                    gameState.l3Index++;
                    renderLevel3Question();
                }, 1500);
            } else {
                gameState.l3MistakeMade = true;
                document.getElementById('l3-feedback').innerHTML = `<p class="text-red-500 font-bold">ä¸æ­£ç¢º (è½åˆ°: ${transcript})</p>`;
            }
        }

        function endLevel3() {
            const accuracy = Math.round((gameState.l3CorrectCount / 10) * 100);
            gameState.scores.l3 = accuracy;
            if (accuracy >= 80) showFinalResult();
            else showResultScreen(false, "L3 æº–ç¢ºç‡æœªé”æ¨™ï¼Œè«‹å¤šè½ç¤ºç¯„ç™¼éŸ³ï¼", () => startLevel(3));
        }

        function showResultScreen(isPass, msg, action) {
            const views = ['view-start', 'view-intro', 'view-level1', 'view-level2', 'view-level3', 'view-result'];
            views.forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById('view-result').classList.remove('hidden');
            
            updateScoreTable();
            document.getElementById('result-user').innerText = gameState.user;
            document.getElementById('result-comment').innerText = msg;
            
            const btnContainer = document.getElementById('action-buttons');
            btnContainer.innerHTML = "";
            const btn = document.createElement('button');
            btn.className = isPass ? "w-full bg-green-500 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-green-600 transition" : "w-full bg-red-500 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-red-600 transition";
            btn.innerText = isPass ? "ä¸‹ä¸€é—œ / å®Œæˆ" : "é‡æ–°æŒ‘æˆ°æœ¬é—œ";
            btn.onclick = action;
            btnContainer.appendChild(btn);
        }

        function showFinalResult() {
            showResultScreen(true, "æ­å–œï¼ä½ å·²é€²å…¥å¤¢æƒ³åäººå ‚ï¼ğŸ†", null);
            
            const avg = (gameState.scores.l1 + gameState.scores.l2 + gameState.scores.l3) / 3;
            let comment = "";
            if (avg >= 95) comment = "æ ¹æœ¬æ˜¯å–®å­—å† è»ï¼ä½ çš„åå­—æœƒè¢«è¨˜åœ¨åäººå ‚ï¼ğŸŒŸ";
            else if (avg >= 90) comment = "å¤ªå„ªç§€äº†ï¼æˆåŠŸå°±åœ¨çœ¼å‰ï¼ğŸ”¥";
            else if (avg >= 80) comment = "Very Good! å¤¢æƒ³å¯¦è¸å®¶ï¼ğŸ‘";
            else comment = "Good job! ç¹¼çºŒåŠªåŠ›ï¼Œä½ æ˜¯æœ€æ£’çš„ï¼ğŸ’ª";

            document.getElementById('result-comment').innerText = comment;
            document.getElementById('result-comment').classList.add('text-lg');
            document.getElementById('action-buttons').innerHTML = `
                <div class="mt-4 text-center">
                    <p class="text-red-500 font-bold animate-pulse text-sm mb-4"><i class="fas fa-camera"></i> è«‹ç¾åœ¨æˆªåœ–æ­¤ç•«é¢ç¹³äº¤ä½œæ¥­</p>
                    <button onclick="location.reload()" class="text-gray-400 underline text-sm">å›åˆ°é¦–é </button>
                </div>
            `;
        }

        function updateScoreTable() {
            document.getElementById('score-l1').innerText = gameState.scores.l1 > 0 ? gameState.scores.l1 + "%" : "--";
            document.getElementById('score-l2').innerText = gameState.scores.l2 > 0 ? gameState.scores.l2 + "%" : "--";
            document.getElementById('score-l3').innerText = gameState.scores.l3 > 0 ? gameState.scores.l3 + "%" : "--";
        }

        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function speak(text, rate = 0.8) {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = rate;
            window.speechSynthesis.speak(utterance);
        }

        function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }
    </script>
</body>
</html>